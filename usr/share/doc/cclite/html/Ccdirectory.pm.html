<?xml version="1.0" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Ccdirectory.pm</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rev="made" href="mailto:root@localhost" />
</head>

<style type="text/css">
<!--
/* default style sheet generated by perltidy */
body {background: #FFFFFF; color: #000000}
pre { color: #000000; 
      background: #F0F0F0;
      font-family: courier;
    } 

.c  { color: #228B22;} /* comment */
.cm { color: #000000;} /* comma */
.co { color: #000000;} /* colon */
.h  { color: #CD5555; font-weight:bold;} /* here-doc-target */
.hh { color: #CD5555; font-style:italic;} /* here-doc-text */
.i  { color: #00688B;} /* identifier */
.j  { color: #CD5555; font-weight:bold;} /* label */
.k  { color: #8B008B; font-weight:bold;} /* keyword */
.m  { color: #FF0000; font-weight:bold;} /* subroutine */
.n  { color: #B452CD;} /* numeric */
.p  { color: #000000;} /* paren */
.pd { color: #228B22; font-style:italic;} /* pod-text */
.pu { color: #000000;} /* punctuation */
.q  { color: #CD5555;} /* quote */
.s  { color: #000000;} /* structure */
.sc { color: #000000;} /* semicolon */
.v  { color: #B452CD;} /* v-string */
.w  { color: #000000;} /* bareword */
-->
</style>
<body style="background-color: white">
<a name="-top-"></a>
<h1>Ccdirectory.pm</h1>

<p><a name="__index__"></a></p>
<!-- INDEX BEGIN -->

<ul>

	<li><a href="#name">NAME</a></li>
	<li><a href="#synopsis">SYNOPSIS</a></li>
	<li><a href="#description">DESCRIPTION</a></li>
	<li><a href="#author">AUTHOR</a></li>
	<li><a href="#copyright">COPYRIGHT</a></li>
	<ul>

		<ul>

			<li><a href="#add_yellow">add_yellow</a></li>
			<li><a href="#show_yellow">show_yellow</a></li>
			<li><a href="#show_yellow_dir1">show_yellow_dir1</a></li>
		</ul>

	</ul>

</ul>
<!-- INDEX END -->
<h2>Code Index:</h2>
<!-- BEGIN CODE INDEX --><a name="code-index"></a>
<ul>
<li><a href="#package-Ccdirectory-">package Ccdirectory</a>
<ul>
<li><a href="#add_yellow-">add_yellow</a></li>
<li><a href="#show_yellow-">show_yellow</a></li>
<li><a href="#show_yellow_dir1-">show_yellow_dir1</a></li>
</ul>
</li>
<li><a href="#EOF-">EOF</a></li>
</ul>
<!-- END CODE INDEX -->

<hr />
<p>
</p>
<h1><a name="name">NAME</a></h1>
<p>Ccdirectory.pm</p>
<p>
</p>
<hr />
<h1><a name="synopsis">SYNOPSIS</a></h1>
<p>Ccdirectory main</p>
<p>
</p>
<hr />
<h1><a name="description">DESCRIPTION</a></h1>
<p>This is the the directory/yellow pages module for Cclite. It's now separated from
the transaction motor, so that custom directories can be built</p>
<p>These functions assume that all the local data has been validated
Probably this is done via Ccvalidate.pm. 
There are extra actions for remote registry checks already</p>
<p>
</p>
<hr />
<h1><a name="author">AUTHOR</a></h1>
<p>Hugh Barnard</p>
<p>
</p>
<hr />
<h1><a name="copyright">COPYRIGHT</a></h1>
<p>(c) Hugh Barnard 2004-2007 GPL Licenced</p>
<pre>
<a name="package-Ccdirectory-"></a><span class="k">package </span><span class="i">Ccdirectory</span><span class="sc">;</span>

<span class="k">use</span> <span class="w">strict</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">vars</span> <span class="q">qw(@ISA @EXPORT)</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Exporter</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Ccu</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Cclitedb</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Cclite</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Ccvalidate</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Ccsecure</span><span class="sc">;</span>

<span class="k">my</span> <span class="i">$VERSION</span> = <span class="n">1.00</span><span class="sc">;</span>
<span class="i">@ISA</span>    = <span class="q">qw(Exporter)</span><span class="sc">;</span>
<span class="i">@EXPORT</span> = <span class="q">qw(add_yellow</span>
  <span class="q">show_yellow</span>
  <span class="q">show_yellow_dir</span>
  <span class="q">show_yellow_dir1</span>
<span class="q">)</span><span class="sc">;</span>

<span class="c"># read messages from literals file, this isn&#39;t fully multilingual yet</span>
<span class="k">our</span> <span class="i">$log</span>      = <span class="w">Log::Log4perl</span><span class="w">-&gt;get_logger</span><span class="s">(</span><span class="q">&quot;Ccdirectory&quot;</span><span class="s">)</span><span class="sc">;</span>
<span class="k">our</span> <span class="i">%messages</span> = <span class="i">readmessages</span><span class="s">(</span><span class="q">&quot;en&quot;</span><span class="s">)</span><span class="sc">;</span>

</pre><p></p>
<h3><a name="add_yellow">add_yellow</a></h3>
<p>add a yellow page, promoted from raw add_database_record to
do specific validations etc. needs fleshing out...
now added, parse of option fields so that the category, parent
category and keywords work out</p>
<pre>
<a name="add_yellow-"></a><span class="k">sub </span><span class="m">add_yellow</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$date</span><span class="cm">,</span> <span class="i">$time</span> <span class="s">)</span> = <span class="i">&amp;Ccu::getdateandtime</span><span class="s">(</span> <span class="k">time</span><span class="s">(</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$$fieldsref</span>{<span class="w">date</span>}   = <span class="i">$date</span><span class="sc">;</span>
    <span class="i">$$fieldsref</span>{<span class="w">status</span>} = <span class="q">&#39;active&#39;</span><span class="sc">;</span>

    <span class="c"># parse the option field</span>
    <span class="s">(</span>
        <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;category&#39;</span>}<span class="cm">,</span>
        <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;parent&#39;</span>}<span class="cm">,</span>
        <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;keywords&#39;</span>}
    <span class="s">)</span> = <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;classification&#39;</span>} =~ <span class="q">/(\d{4})\s(\d{4})(.*)/</span><span class="sc">;</span>

    <span class="c">###$log-&gt;debug(&quot;string: $fieldsref-&gt;{&#39;category&#39;}, $fieldsref-&gt;{&#39;parent&#39;}, $fieldsref-&gt;{&#39;keywords&#39;}  = $fieldsref-&gt;{&#39;classification&#39;}&quot;) ;</span>
    <span class="c">#</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$cookies</span> <span class="s">)</span> =
      <span class="i">add_database_record</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="s">(</span> <span class="n">1</span><span class="cm">,</span> <span class="i">$$fieldsref</span>{<span class="w">home</span>}<span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$messages</span>{<span class="w">directorypageadded</span>}<span class="cm">,</span>
        <span class="q">&quot;result.html&quot;</span><span class="cm">,</span> <span class="q">&quot;&quot;</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="show_yellow">show_yellow</a></h3>
<p>Join the specific yellow pages record with the user
record to display telephone number and email etc.</p>
<p>Run show balance and volume to show balance and volume at 
bottom of ad. This is a pretty heavy operation and perhaps
should be done as a nightly batch to generate static html</p>
<p>This also contains SQL at present, goodbye n-tier purity!</p>
<pre>
<a name="show_yellow-"></a><span class="k">sub </span><span class="m">show_yellow</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$x</span><span class="sc">;</span>

    <span class="c"># DATE_FORMAT(&#39;2003-10-03&#39;,GET_FORMAT(DATE,&#39;EUR&#39;));</span>

    <span class="k">my</span> <span class="i">$sqlstring</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">  SELECT DISTINCT u.userEmail, u.userStatus,  y.id, date_format(y.date,get_format(date,&#39;eur&#39;)) as dt, y.subject, y.type, y.keywords, y.unit, y.tradeCurrency, y.price, y.truelets,</span>
<span class="hh">                  y.description, u.userMobile, u.userTelephone, y.fromuserid</span>
<span class="hh">  FROM om_yellowpages y, om_users u</span>
<span class="hh">  WHERE (</span>
<span class="hh">  y.fromuserid = u.userLogin AND y.id = &#39;$$fieldsref{id}&#39;)</span>
<span class="h">EOT</span>

    <span class="c">###$log-&gt;debug(&quot;sqlstring is $sqlstring&quot;) ;</span>
    <span class="c"># get equi-joined table</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$hash_ref</span> <span class="s">)</span> = <span class="i">sqlraw</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$sqlstring</span><span class="cm">,</span> <span class="q">&#39;id&#39;</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%report</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$html</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$record_ref</span><span class="sc">;</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$hash_key</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%$hash_ref</span> <span class="s">)</span> <span class="s">{</span>

        <span class="c"># my $parent = &quot;$hash_ref-&gt;{$hash_key}-&gt;{parent}&quot; ;</span>
        <span class="i">$record_ref</span> = <span class="i">$hash_ref</span>-&gt;{<span class="i">$hash_key</span>}<span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$r</span><span class="cm">,</span> <span class="i">$m</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$balvol</span><span class="cm">,</span> <span class="i">$templ</span><span class="cm">,</span> <span class="i">$c</span> <span class="s">)</span> =
      <span class="i">show_balance_and_volume</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$record_ref</span>-&gt;{<span class="q">&#39;fromuserid&#39;</span>}<span class="cm">,</span>
        <span class="q">&#39;html&#39;</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$record_ref</span>-&gt;{<span class="q">&#39;balanceandvolume&#39;</span>} = <span class="i">$balvol</span><span class="sc">;</span>

    <span class="i">$html</span> = <span class="q">&quot;&lt;table&gt;$html&lt;/table&gt;&quot;</span><span class="sc">;</span>

    <span class="c">#FIXME: result template used if result not supplied, should always be...</span>
    <span class="k">my</span> <span class="i">$template</span> = <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;resulttemplate&#39;</span>} || <span class="q">&quot;result.html&quot;</span><span class="sc">;</span>
    <span class="k">return</span> <span class="s">(</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$template</span><span class="cm">,</span> <span class="i">$record_ref</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="show_yellow_dir1">show_yellow_dir1</a></h3>
<p>Show yellow pages directory by category description, based on the work done by Mary Fee
for Camden. Should work with any scheme that has categories and parent categories
only nested once, otherwise needs re-writing to be recursive</p>
<p>Shows all lower level description in a big craiglist like table, will make a big
page when there lots of ads.</p>
<p>Also this is a lot simpler that the first one with its expanding and contracting
display etc. 06/2007</p>
<p>sql etc. moved to Cclitedb in 05/2010</p>

<pre>
<a name="show_yellow_dir1-"></a><span class="k">sub </span><span class="m">show_yellow_dir1</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$sqlstring</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$interval</span>    = <span class="n">1</span><span class="sc">;</span>        <span class="c"># one week for displaying items as new...</span>
    <span class="k">my</span> <span class="i">$html</span>        = <span class="q">&quot;&lt;tr&gt;&quot;</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$width_count</span> = <span class="n">1</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$max_depth</span> = <span class="i">$$fieldsref</span>{<span class="w">maxdepth</span>}
      || <span class="n">3</span><span class="sc">;</span>                     <span class="c"># four cells wide as default if not specified</span>
    <span class="k">my</span> <span class="i">$item_count</span><span class="sc">;</span>

    <span class="c"># changed $fieldsref-&gt;{&#39;getdetail&#39;} to 0, should be just category</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$new_items_hash_ref</span><span class="cm">,</span> <span class="i">$yellowdirectory_hash_ref</span> <span class="s">)</span> =
      <span class="i">get_yellowpages_directory_data</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$interval</span><span class="cm">,</span> <span class="n">0</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span> <span class="k">sort</span> <span class="k">keys</span> <span class="i">%$yellowdirectory_hash_ref</span> <span class="s">)</span> <span class="s">{</span>

        <span class="k">my</span> <span class="i">$type</span> =
          <span class="i">$yellowdirectory_hash_ref</span>-&gt;{<span class="i">$key</span>}
          -&gt;{<span class="q">&#39;type&#39;</span>}<span class="sc">;</span>           <span class="c">#just for convenience to shorten it</span>

        <span class="c">###$log-&gt;debug(&quot;key is $key type is $type&quot;) ;</span>

        <span class="i">$yellowdirectory_hash_ref</span>-&gt;{<span class="i">$key</span>}-&gt;{<span class="q">&#39;type&#39;</span>} =
          <span class="i">$messages</span>{<span class="i">$type</span>}<span class="sc">;</span>   <span class="c"># replace offered/wanted with multilingual message</span>

  <span class="c"># if there&#39;s recent ads in this category add a small &#39;New&#39; flag in the listing</span>
        <span class="k">if</span> <span class="s">(</span> <span class="k">exists</span> <span class="i">$new_items_hash_ref</span>-&gt;{<span class="i">$key</span>}-&gt;{<span class="q">&#39;description&#39;</span>} <span class="s">)</span> <span class="s">{</span>
            <span class="i">$yellowdirectory_hash_ref</span>-&gt;{<span class="i">$key</span>}-&gt;{<span class="q">&#39;literal&#39;</span>} =
              <span class="i">$yellowdirectory_hash_ref</span>-&gt;{<span class="i">$key</span>}-&gt;{<span class="q">&#39;description&#39;</span>}
              . <span class="q">&quot;&lt;sup class=\&quot;spaced\&quot;&gt;$messages{&#39;new&#39;}&lt;\/sup&gt;&quot;</span><span class="sc">;</span>
        <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
            <span class="i">$yellowdirectory_hash_ref</span>-&gt;{<span class="i">$key</span>}-&gt;{<span class="q">&#39;literal&#39;</span>} =
              <span class="i">$yellowdirectory_hash_ref</span>-&gt;{<span class="i">$key</span>}-&gt;{<span class="q">&#39;description&#39;</span>}<span class="sc">;</span>
        <span class="s">}</span>

        <span class="c"># make a url out of the description field...</span>
        <span class="i">$yellowdirectory_hash_ref</span>-&gt;{<span class="i">$key</span>}-&gt;{<span class="q">&#39;url&#39;</span>} = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">         &lt;a title=&quot;get listing by category&quot; href=&quot;/cgi-bin/cclite.cgi?action=showyellowbycat&amp;string1=$yellowdirectory_hash_ref-&gt;{$key}-&gt;{&#39;description&#39;}&quot;&gt;</span>
<span class="hh">         $yellowdirectory_hash_ref-&gt;{$key}-&gt;{&#39;literal&#39;}</span>
<span class="hh">         &lt;/a&gt;</span>
<span class="h">EOT</span>

        <span class="k">my</span> <span class="i">$row</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">        &lt;td class=&quot;$type&quot;&gt;$yellowdirectory_hash_ref-&gt;{$key}-&gt;{&#39;url&#39;}&lt;/td&gt;&lt;td&gt;&amp;nbsp;&lt;/td&gt;&lt;td class=&quot;$type&quot;&gt;$yellowdirectory_hash_ref-&gt;{$key}-&gt;{&#39;majorcount&#39;}&lt;/td&gt;&lt;td&gt;&amp;nbsp;&lt;/td&gt;</span>
<span class="h">EOT</span>

        <span class="c"># start a new row, if at max width, else just add on</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$width_count</span> == <span class="i">$max_depth</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$html</span> .= <span class="q">&quot;$row&lt;/tr&gt;\n&lt;tr&gt;&quot;</span><span class="sc">;</span>
            <span class="i">$width_count</span> = <span class="n">1</span><span class="sc">;</span>

        <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
            <span class="i">$html</span> .= <span class="i">$row</span><span class="sc">;</span>
            <span class="i">$width_count</span>++<span class="sc">;</span>
        <span class="s">}</span>

    <span class="s">}</span>

    <span class="c"># pad and row-terminate the end of the table, if necessary</span>
    <span class="k">my</span> <span class="i">$endtable</span> =
      <span class="q">&quot;&lt;td&gt;&lt;/td&gt;&quot;</span> x <span class="s">(</span> <span class="s">(</span> <span class="i">$max_depth</span> - <span class="i">$width_count</span> <span class="s">)</span> * <span class="i">$item_count</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$html</span> .= <span class="q">&quot;$endtable&lt;/tr&gt;&quot;</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$html</span> !~ <span class="q">/&lt;tr&gt;$/</span> <span class="s">)</span><span class="sc">;</span>

    <span class="i">$html</span> = <span class="q">&quot;&lt;table&gt;&lt;tbody class=\&quot;stripy\&quot;&gt;$html&lt;/tbody&gt;&lt;/table&gt;&quot;</span><span class="sc">;</span>

    <span class="k">return</span> <span class="s">(</span> <span class="n">0</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="q">&quot;result.html&quot;</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="n">1</span><span class="sc">;</span>

<a name="EOF-"></a></pre></body>

</html>
