<?xml version="1.0" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>read_from_jabber_anyevent.pl</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rev="made" href="mailto:root@localhost" />
</head>

<style type="text/css">
<!--
/* default style sheet generated by perltidy */
body {background: #FFFFFF; color: #000000}
pre { color: #000000; 
      background: #F0F0F0;
      font-family: courier;
    } 

.c  { color: #228B22;} /* comment */
.cm { color: #000000;} /* comma */
.co { color: #000000;} /* colon */
.h  { color: #CD5555; font-weight:bold;} /* here-doc-target */
.hh { color: #CD5555; font-style:italic;} /* here-doc-text */
.i  { color: #00688B;} /* identifier */
.j  { color: #CD5555; font-weight:bold;} /* label */
.k  { color: #8B008B; font-weight:bold;} /* keyword */
.m  { color: #FF0000; font-weight:bold;} /* subroutine */
.n  { color: #B452CD;} /* numeric */
.p  { color: #000000;} /* paren */
.pd { color: #228B22; font-style:italic;} /* pod-text */
.pu { color: #000000;} /* punctuation */
.q  { color: #CD5555;} /* quote */
.s  { color: #000000;} /* structure */
.sc { color: #000000;} /* semicolon */
.v  { color: #B452CD;} /* v-string */
.w  { color: #000000;} /* bareword */
-->
</style>
<body style="background-color: white">
<a name="-top-"></a>
<h1>read_from_jabber_anyevent.pl</h1>


<!-- INDEX BEGIN -->
<div name="index">
<p><a name="__index__"></a></p>

<ul>

	<ul>

		<ul>

			<li><a href="#process_cclite_message">process_cclite_message</a></li>
		</ul>

	</ul>

</ul>

<hr name="index" />
</div>
<!-- INDEX END -->
<h2>Code Index:</h2>
<!-- BEGIN CODE INDEX --><a name="code-index"></a>
<ul>
<li><a href="#process_cclite_message-">package main</a>
<ul>
<li><a href="#process_cclite_message-">process_cclite_message</a></li>
</ul>
</li>
<li><a href="#EOF-">EOF</a></li>
</ul>
<!-- END CODE INDEX -->

<p></p>
<h3><a name="process_cclite_message">process_cclite_message</a></h3>
<p>A crude first attempt to process GPG encoded Jabber input bodies
containing 'send' or 'balance' transactions. Does not send encrypted
receipts at present...</p>

<hr /><pre>#!/usr/bin/perl



</pre><pre>
<a name="process_cclite_message-"></a><span class="k">sub </span><span class="m">process_cclite_message</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$body</span><span class="cm">,</span> <span class="i">$user</span><span class="cm">,</span> <span class="i">$host</span><span class="cm">,</span> <span class="i">$res</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$transaction_found</span><span class="cm">,</span> <span class="i">$transaction_line</span><span class="cm">,</span> <span class="i">$transaction_description_ref</span><span class="cm">,</span>
        <span class="i">$parse_type</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># originator is mail style address, resource not used at present...</span>
    <span class="k">my</span> <span class="i">$originator</span> = <span class="q">&quot;$user\@$host&quot;</span><span class="sc">;</span>

    <span class="c"># if encoded, assumed to be a transaction...</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$body</span> =~ <span class="q">/BEGIN PGP MESSAGE/</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">open</span><span class="s">(</span> <span class="w">JABBER</span><span class="cm">,</span> <span class="q">&quot;&gt;$message_file&quot;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">print</span> <span class="i">JABBER</span> <span class="i">$body</span><span class="sc">;</span>
        <span class="k">close</span><span class="s">(</span><span class="w">JABBER</span><span class="s">)</span><span class="sc">;</span>
        <span class="s">(</span> <span class="i">$transaction_found</span><span class="cm">,</span> <span class="i">$transaction_line</span> <span class="s">)</span> =
          <span class="i">decode_decrypt_reformat</span><span class="s">(</span> <span class="i">$passphrase</span><span class="cm">,</span> <span class="i">$message_file</span><span class="cm">,</span> <span class="i">$reformat</span><span class="cm">,</span>
            <span class="i">$decrypt</span><span class="cm">,</span> <span class="i">$logfile</span><span class="cm">,</span> <span class="i">$trace</span> <span class="s">)</span><span class="sc">;</span>

        <span class="s">(</span> <span class="i">$parse_type</span><span class="cm">,</span> <span class="i">$transaction_description_ref</span> <span class="s">)</span> =
          <span class="i">mail_message_parse</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="i">$originator</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span>
            <span class="i">$transaction_line</span> <span class="s">)</span><span class="sc">;</span>

        <span class="c"># add &#39;via jabber&#39; literal to description of transaction</span>
        <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;description&#39;</span>} =
          <span class="q">&quot;$messages{&#39;viajabber&#39;} &quot;</span>
          . <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;description&#39;</span>}<span class="sc">;</span>

<span class="c">#FIXME: we have output, error and text within transaction, needs simplifying</span>
<span class="c"># also add the Via Jabber/Via Email prefix at this stage before transaction processing...</span>
        <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span> <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;error&#39;</span>} <span class="s">)</span>
            &amp;&amp; <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;type&#39;</span>} <span class="k">eq</span> <span class="q">&#39;send&#39;</span> <span class="s">)</span>
        <span class="s">{</span>
            <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;output_message&#39;</span>} =
              <span class="i">mail_transaction</span><span class="s">(</span><span class="i">$transaction_description_ref</span><span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;type&#39;</span>} <span class="k">eq</span> <span class="q">&#39;balance&#39;</span> <span class="s">)</span> <span class="s">{</span>

            <span class="c">###my $text = $transaction_description_ref-&gt;{&#39;text&#39;} ;</span>
            <span class="c">###my $type = $transaction_description_ref-&gt;{&#39;type&#39;};</span>
            <span class="c">###$log-&gt;debug(&quot;balance transaction t:$text ty:$type&quot;);</span>

            <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;output_message&#39;</span>} =
              <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;text&#39;</span>}<span class="sc">;</span>
        <span class="s">}</span>

    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$output</span> =
<span class="q">&quot;$transaction_description_ref-&gt;{&#39;error&#39;} $transaction_description_ref-&gt;{&#39;output_message&#39;}&quot;</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$type</span> = <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;type&#39;</span>}<span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> !<span class="i">$transaction_found</span> <span class="s">)</span> <span class="s">{</span>
      <span class="k">return</span> <span class="q">&quot;no transaction detected&quot;</span> <span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
         <span class="k">return</span> <span class="q">&quot;$transaction_description_ref-&gt;{&#39;error&#39;} $transaction_description_ref-&gt;{&#39;output_message&#39;}&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

<span class="s">}</span>

<span class="k">use</span> <span class="w">strict</span> <span class="sc">;</span>
<span class="k">use</span> <span class="w">lib</span> <span class="q">&#39;../../../lib&#39;</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">utf8</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">AnyEvent</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">AnyEvent::XMPP::IM::Connection</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">AnyEvent::XMPP::IM::Presence</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">AnyEvent::XMPP::Util</span> <span class="q">qw/split_jid/</span><span class="sc">;</span>

<span class="k">use</span> <span class="w">Log::Log4perl</span><span class="sc">;</span>

<span class="c"># and cclite support</span>
<span class="k">use</span> <span class="w">Ccconfiguration</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Ccmailgateway</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Cclitedb</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Cclite</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Cccrypto</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Cccookie</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Ccu</span><span class="sc">;</span>

<span class="c"># use pid to distinguish instances and jid for files</span>
<span class="k">our</span> <span class="i">$pid</span> = <span class="i">$$</span> <span class="sc">;</span>

<span class="k">my</span> <span class="i">%configuration</span>          = <span class="w">readconfiguration</span><span class="sc">;</span>
<span class="k">my</span> <span class="i">$configuration_hash_ref</span> = \<span class="i">%configuration</span><span class="sc">;</span>

<span class="c"># message language now decided by decide_language 08/2011</span>
<span class="k">our</span> <span class="i">%messages</span> = <span class="i">readmessages</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

<span class="w">Log::Log4perl</span><span class="w">-&gt;init</span><span class="s">(</span> <span class="i">$configuration</span>{<span class="q">&#39;loggerconfig&#39;</span>} <span class="s">)</span><span class="sc">;</span>
<span class="k">our</span> <span class="i">$log</span> = <span class="w">Log::Log4perl</span><span class="w">-&gt;get_logger</span><span class="s">(</span><span class="q">&quot;read_from_jabber&quot;</span><span class="s">)</span><span class="sc">;</span>

<span class="c"># don&#39;t need at present run from command line...</span>
<span class="k">my</span> <span class="i">$cookieref</span> = <span class="i">get_cookie</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

<span class="c"># specific configuration file for this, for the moment...</span>
<span class="k">my</span> <span class="i">%jabber_configuration</span> = <span class="i">readconfiguration</span><span class="s">(</span><span class="q">&#39;../../../config/readjabber.cf&#39;</span><span class="s">)</span><span class="sc">;</span>

<span class="k">my</span> <span class="i">$server</span>   = <span class="i">$jabber_configuration</span>{<span class="q">&#39;server&#39;</span>}<span class="sc">;</span>
<span class="k">my</span> <span class="i">$port</span>     = <span class="i">$jabber_configuration</span>{<span class="q">&#39;port&#39;</span>} || <span class="n">5222</span> <span class="sc">;</span>
<span class="k">my</span> <span class="i">$server_user</span> = <span class="i">$jabber_configuration</span>{<span class="q">&#39;username&#39;</span>}<span class="sc">;</span>
<span class="k">my</span> <span class="i">$server_password</span> = <span class="i">$jabber_configuration</span>{<span class="q">&#39;password&#39;</span>}<span class="sc">;</span>

<span class="c"># this is experimental, multiple cclite bots, distinguished by registry name</span>
<span class="k">my</span> <span class="i">$resource</span> = <span class="i">$jabber_configuration</span>{<span class="q">&#39;hardcoded_registry&#39;</span>}<span class="sc">;</span>

<span class="k">my</span> <span class="i">$temp_directory</span> = <span class="i">$jabber_configuration</span>{<span class="q">&#39;temp_directory&#39;</span>}<span class="sc">;</span>

<span class="k">our</span> <span class="i">$message_file</span> =
  <span class="q">&quot;$jabber_configuration{&#39;temp_directory&#39;}/$jabber_configuration{&#39;message&#39;}&quot;</span><span class="sc">;</span>
<span class="k">our</span> <span class="i">$reformat</span> =
  <span class="q">&quot;$jabber_configuration{&#39;temp_directory&#39;}/$jabber_configuration{&#39;reformat&#39;}&quot;</span><span class="sc">;</span>
<span class="k">our</span> <span class="i">$decrypt</span> =
  <span class="q">&quot;$jabber_configuration{&#39;temp_directory&#39;}/$jabber_configuration{&#39;decrypt&#39;}&quot;</span><span class="sc">;</span>
<span class="k">our</span> <span class="i">$encrypted</span> =
  <span class="q">&quot;$jabber_configuration{&#39;temp_directory&#39;}/$jabber_configuration{&#39;encrypted&#39;}&quot;</span><span class="sc">;</span>

<span class="c"># STDERR for gpg operations, if specified...</span>
<span class="k">our</span> <span class="i">$logfile</span> =
  <span class="q">&quot;$jabber_configuration{&#39;temp_directory&#39;}/$jabber_configuration{&#39;logfile&#39;}&quot;</span><span class="sc">;</span>

<span class="c"># turns gpg trace on and off, prints to STDOUT (or STDERR?)</span>
<span class="k">our</span> <span class="i">$trace</span> = <span class="i">$jabber_configuration</span>{<span class="q">&#39;trace&#39;</span>}<span class="sc">;</span>

<span class="c"># sleep in seconds for processing loop, not needed...</span>
<span class="k">our</span> <span class="i">$sleep</span> = <span class="i">$jabber_configuration</span>{<span class="q">&#39;sleep&#39;</span>}<span class="sc">;</span>

<span class="c"># clearly this is very insecure, should be held as a smartcard token for example, this</span>
<span class="c"># passphrase unlocks the private key for decrpyting the incoming transactions</span>
<span class="c"># users private key on client is used to sign transactions</span>

<span class="c"># note the key and the running user must correspond, otherwise the key won&#39;t get released by gpg</span>
<span class="k">our</span> <span class="i">$passphrase</span> = <span class="i">$jabber_configuration</span>{<span class="q">&#39;passphrase&#39;</span>}<span class="sc">;</span>

<span class="c"># this will leave data in the intermediate files and mail in the mailbox, if set to 1, avoids</span>
<span class="c"># resetting/resending etc. when debugging</span>
<span class="k">my</span> <span class="i">$debug</span> = <span class="i">$jabber_configuration</span>{<span class="q">&#39;debug&#39;</span>}<span class="sc">;</span>

<span class="c"># for cron, replace these with hardcoded registry name</span>
<span class="k">our</span> <span class="i">$registry</span> = <span class="i">$jabber_configuration</span>{<span class="q">&#39;hardcoded_registry&#39;</span>}
  || <span class="i">$$cookieref</span>{<span class="w">registry</span>}<span class="sc">;</span>




<span class="c"># print out all the values in the configuration file, if debugging...</span>
<span class="k">if</span> <span class="s">(</span><span class="i">$debug</span><span class="s">)</span> <span class="s">{</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%jabber_configuration</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">print</span> <span class="q">&quot;$key = $jabber_configuration{$key}\n&quot;</span><span class="sc">;</span>

    <span class="s">}</span>
<span class="s">}</span>

<span class="k">my</span> <span class="i">$counter</span> = <span class="q">&#39;a&#39;</span> <span class="sc">;</span>
<span class="k">my</span> <span class="i">$pres</span> <span class="sc">;</span>
<span class="k">my</span> <span class="i">%replies</span><span class="sc">;</span>

<span class="k">my</span> <span class="i">$j</span> = <span class="w">AnyEvent</span><span class="w">-&gt;condvar</span><span class="sc">;</span>

<span class="c"># Enter your credentials here</span>
<span class="k">my</span>  <span class="i">$cl</span> = <span class="w">AnyEvent::XMPP::IM::Connection</span><span class="w">-&gt;new</span> <span class="s">(</span>
      <span class="w">jid</span>              <span class="cm">=&gt;</span> <span class="q">&quot;$server_user@$server&quot;</span><span class="cm">,</span>
      <span class="w">password</span>         <span class="cm">=&gt;</span> <span class="i">$server_password</span><span class="cm">,</span>
   <span class="s">)</span><span class="sc">;</span>

 
 <span class="c"># The Connection object ($con here), is</span>
 <span class="c"># always the first argument in the call backs. </span>
<span class="i">$cl</span><span class="i">-&gt;reg_cb</span> <span class="s">(</span>
   <span class="w">session_ready</span> <span class="cm">=&gt;</span> <span class="k">sub</span> <span class="s">{</span>
      <span class="k">my</span> <span class="s">(</span><span class="i">$con</span><span class="cm">,</span> <span class="i">$acc</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
      <span class="k">print</span> <span class="q">&quot;session ready\n&quot;</span><span class="sc">;</span>
   <span class="s">}</span><span class="cm">,</span>
   <span class="w">connect</span> <span class="cm">=&gt;</span> <span class="k">sub</span> <span class="s">{</span>
      <span class="k">print</span> <span class="q">&quot;Connected \n&quot;</span><span class="sc">;</span>
   <span class="s">}</span><span class="cm">,</span>
   <span class="w">message</span> <span class="cm">=&gt;</span> <span class="k">sub</span> <span class="s">{</span>
      <span class="k">my</span> <span class="s">(</span><span class="i">$con</span><span class="cm">,</span> <span class="i">$msg</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
      <span class="k">if</span> <span class="s">(</span><span class="i">$msg</span><span class="i">-&gt;any_body</span> <span class="k">ne</span> <span class="q">&quot;&quot;</span><span class="s">)</span><span class="s">{</span>
         <span class="k">my</span> <span class="s">(</span><span class="i">$user</span><span class="cm">,</span> <span class="i">$host</span><span class="cm">,</span> <span class="i">$res</span><span class="s">)</span> = <span class="w">split_jid</span> <span class="s">(</span><span class="i">$msg</span><span class="i">-&gt;from</span><span class="s">)</span><span class="sc">;</span>
         <span class="k">my</span> <span class="i">$username</span> = <span class="k">join</span><span class="s">(</span><span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="i">$user</span><span class="cm">,</span><span class="q">&#39;@&#39;</span><span class="cm">,</span><span class="i">$host</span><span class="s">)</span><span class="sc">;</span>
 
 
         <span class="k">my</span> <span class="i">$output</span> = <span class="i">process_cclite_message</span> <span class="s">(</span> <span class="i">$msg</span><span class="cm">,</span> <span class="i">$user</span><span class="cm">,</span> <span class="i">$host</span><span class="cm">,</span> <span class="i">$res</span> <span class="s">)</span><span class="sc">;</span>

         <span class="k">print</span> <span class="q">&quot;Message from &quot;</span> . <span class="i">$username</span> . <span class="q">&quot;:\n&quot;</span><span class="sc">;</span>
         <span class="k">print</span> <span class="q">&quot;Message: &quot;</span> . <span class="i">$msg</span><span class="i">-&gt;any_body</span> . <span class="q">&quot;\n&quot;</span><span class="sc">;</span>
         <span class="k">print</span> <span class="q">&quot;\n&quot;</span><span class="sc">;</span>
         
        <span class="k">my</span> <span class="i">$immsg</span> = <span class="w">AnyEvent::XMPP::IM::Message</span><span class="w">-&gt;new</span> <span class="s">(</span><span class="w">to</span> <span class="cm">=&gt;</span> <span class="i">$username</span><span class="cm">,</span> <span class="w">body</span> <span class="cm">=&gt;</span> <span class="i">$output</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">$immsg</span><span class="i">-&gt;send</span> <span class="s">(</span><span class="i">$con</span><span class="s">)</span> <span class="sc">;</span> 
      <span class="s">}</span>
   <span class="s">}</span><span class="cm">,</span>
   <span class="w">stream_pre_authentication</span> <span class="cm">=&gt;</span> <span class="k">sub</span> <span class="s">{</span>
      <span class="k">print</span> <span class="q">&quot;Pre-authentication \n&quot;</span><span class="sc">;</span>
   <span class="s">}</span><span class="cm">,</span>
   <span class="w">disconnect</span> <span class="cm">=&gt;</span> <span class="k">sub</span> <span class="s">{</span>
      <span class="k">my</span> <span class="s">(</span><span class="i">$con</span><span class="cm">,</span> <span class="i">$h</span><span class="cm">,</span> <span class="i">$p</span><span class="cm">,</span> <span class="i">$reason</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
      <span class="k">warn</span> <span class="q">&quot;Disconnected from $h:$p: $reason\n&quot;</span><span class="sc">;</span>
      <span class="i">$j</span><span class="i">-&gt;broadcast</span><span class="sc">;</span>
   <span class="s">}</span><span class="cm">,</span>
   <span class="w">error</span> <span class="cm">=&gt;</span> <span class="k">sub</span> <span class="s">{</span>
      <span class="k">my</span> <span class="s">(</span><span class="i">$cl</span><span class="cm">,</span> <span class="i">$err</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
      <span class="k">print</span> <span class="q">&quot;ERROR: &quot;</span> . <span class="i">$err</span><span class="i">-&gt;string</span> . <span class="q">&quot;\n&quot;</span><span class="sc">;</span>
   <span class="s">}</span><span class="cm">,</span>
   <span class="w">roster_update</span> <span class="cm">=&gt;</span> <span class="k">sub</span> <span class="s">{</span>
      <span class="k">my</span> <span class="s">(</span><span class="i">$con</span><span class="cm">,</span> <span class="i">$roster</span><span class="cm">,</span> <span class="i">$contacts</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
      <span class="k">for</span> <span class="k">my</span> <span class="i">$contact</span> <span class="s">(</span><span class="i">$roster</span><span class="i">-&gt;get_contacts</span><span class="s">)</span> <span class="s">{</span>
         <span class="k">print</span> <span class="q">&quot;Roster Update: &quot;</span> . <span class="i">$contact</span><span class="i">-&gt;jid</span> . <span class="q">&quot;\n&quot;</span><span class="sc">;</span>
      <span class="s">}</span>
   <span class="s">}</span><span class="cm">,</span>
   <span class="w">presence_update</span> <span class="cm">=&gt;</span> <span class="k">sub</span> <span class="s">{</span>
      <span class="k">my</span> <span class="s">(</span><span class="i">$con</span><span class="cm">,</span> <span class="i">$roster</span><span class="cm">,</span> <span class="i">$contacts</span><span class="cm">,</span> <span class="i">$old_presence</span><span class="cm">,</span> <span class="i">$new_presence</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
      <span class="k">for</span> <span class="k">my</span> <span class="i">$cont</span> <span class="s">(</span><span class="i">$contacts</span><span class="s">)</span> <span class="s">{</span>
         <span class="k">if</span><span class="s">(</span><span class="i">$pres</span> = <span class="i">$cont</span><span class="i">-&gt;get_priority_presence</span> <span class="k">ne</span> <span class="k">undef</span><span class="s">)</span><span class="s">{</span>
            <span class="c"># When user is online</span>
            <span class="k">print</span> <span class="q">&quot;contact: &quot;</span> . <span class="i">$cont</span><span class="i">-&gt;jid</span> . <span class="q">&quot;\n&quot;</span><span class="sc">;</span>
            <span class="k">print</span> <span class="q">&quot;Presence: &quot;</span> . <span class="i">$pres</span> . <span class="q">&quot;\n&quot;</span><span class="sc">;</span>
            <span class="k">print</span> <span class="q">&quot;Status: &quot;</span> . <span class="i">$new_presence</span><span class="i">-&gt;show</span> . <span class="q">&quot;\n&quot;</span><span class="sc">;</span>
            <span class="k">print</span> <span class="q">&quot;Status Message: &quot;</span> . <span class="i">$new_presence</span><span class="i">-&gt;status</span> . <span class="q">&quot;\n&quot;</span><span class="sc">;</span>

            <span class="k">if</span> <span class="s">(</span><span class="i">$cont</span><span class="i">-&gt;is_on_roster</span> <span class="k">ne</span> <span class="k">undef</span><span class="s">)</span><span class="s">{</span>
               <span class="k">print</span> <span class="q">&quot;Is On Roster: &quot;</span> . <span class="i">$cont</span><span class="i">-&gt;is_on_roster</span><span class="s">(</span><span class="s">)</span> . <span class="q">&quot;\n&quot;</span><span class="sc">;</span>
            <span class="s">}</span>
         <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
            <span class="c"># When user has logged off</span>
            <span class="k">print</span> <span class="i">$cont</span><span class="i">-&gt;jid</span> . <span class="q">&quot;\n&quot;</span><span class="sc">;</span>
            <span class="k">print</span> <span class="q">&quot;Status offline \n&quot;</span><span class="sc">;</span>
         <span class="s">}</span>
      <span class="s">}</span>
   <span class="s">}</span><span class="cm">,</span>
   <span class="w">message_error</span> <span class="cm">=&gt;</span> <span class="k">sub</span> <span class="s">{</span>
      <span class="k">print</span> <span class="q">&quot;error&quot;</span><span class="sc">;</span>
   <span class="s">}</span>
<span class="s">)</span><span class="sc">;</span>
<span class="i">$cl</span><span class="i">-&gt;connect</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
<span class="i">$j</span><span class="i">-&gt;wait</span><span class="sc">;</span>
<a name="EOF-"></a></pre></body>

</html>
